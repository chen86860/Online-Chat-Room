<!DOCTYPE html>
<html lang="en">

<head>
  <title>chatRoom</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="../css/style.css">
  <link rel="stylesheet" type="text/css" href="../css/iconfont.css">
  <link href="http://cdn.staticfile.org/emoji/0.2.2/emoji.css" rel="stylesheet" type="text/css" />
  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/socket.io.js"></script>
  <script src="../lib/monent.js"></script>
  <script src="../lib/vue.js"></script>
  <script src="http://cdn.staticfile.org/emoji/0.2.2/emoji.js"></script>
</head>

<body>
  <input type="hidden" name="" value="<%= roomId %>" id="roomId">
  <div class="chatBox" id="chat">
    <div class="chatBox-title">
      <div class="chatBox-info">
        <h3 class="chatBox-info-name">Â∏ÉË∞∑È∏ü‰ºòÊÉ†Êé®Ëçê
          <span id='count'>({{count}})</span>
        </h3>
      </div>
      <div class="chatBox-switch">
        <i class="iconfont icon-close" title="ÂÖ≥Èó≠"></i>
      </div>
    </div>
    <div class="chatBox-content">
      <div class="chatBox-content-main">
        <ul class="chatBox-ul">
          <li v-for='item in messages' :key="item.id" :class="{'chatRoom-notice': item.type==3,'chatRoom-me': item.type==1}">
            <template v-if='item.type==1'>
              <cite>
                  <i>{{item.time}}</i>
                  <span>
                   {{item.name}}
                </span> 
                </cite>
              <div class='chatRoom-user'><img :src='item.src' />

              </div>
              <div class='chatRoom-user-text'>
                {{item.info}}
              </div>
            </template>
            <template v-if='item.type==2'>
              <cite>
                  <span>{{item.name}}</span>
                  <i>{{item.time}}</i>
                </cite>
              <div class='chatRoom-user'><img :src='item.src' />
              </div>
              <div class='chatRoom-user-text' v-if='item.info' v-html='item.info'></div>
              <div class="chatRoom-user-text chatRoom-img" v-if='item.img'>
                <img :src="item.img + '_400x400q50'" alt="" />
              </div>
            </template>
            <template v-if='item.type==3'>
              {{item.info}}
            </template>
          </li>
        </ul>
      </div>
      <div class="chatBox-content-footer">
        <div class="chatBox-textarea">
          <span class="chatBox-icon iconfont icon-xiaolian" title="Ë°®ÊÉÖ" @click='showPannel'></span>
          <textarea class="textarea" v-model='textarea' @keyup.enter.stop.prevent="sendText" v-focus></textarea>
          <span class="chatBox-btn-send" @click="sendMsg">ÂèëÈÄÅ</span>
        </div>

      </div>
      <transition name='fade'>
        <div class="facewrap" v-if='showEmoji'>
          <ul>
            <li v-for='e in emojis' :key='e.id' @click='selectE(e)' v-html="'&#x' + e.code + ';'"></li>
          </ul>
        </div>
      </transition>
    </div>
  </div>
  <script>
    const socket = io.connect()

    var face = new Vue({
      el: '#chat',
      data() {
        return {
          emojis: [
            {
              code: "1F60D", name: "smiling face with heart-shaped eyes", native: "üòç"
            },
            {
              code: "1F61C", name: "face with stuck-out tongue and winking eye", native: "üòú"
            },
            {
              code: "1F61D", name: "face with stuck-out tongue and tightly-closed eyes", native: "üòù"
            },
            {
              code: "1F603", name: "smiling face with open mouth", native: "üòÉ"
            },
            {
              code: "1F60B", name: "face savouring delicious food", native: "üòã"
            },
            {
              code: "1F618", name: "face throwing a kiss", native: "üòò"
            },
            {
              code: "1F61A", name: "kissing face with closed eyes", native: "üòö"
            },
            {
              code: "1F637", name: "face with medical mask", native: "üò∑"
            },
            {
              code: "1F633", name: "flushed face", native: "üò≥"
            },
            {
              code: "1F605", name: "smiling face with open mouth and cold sweat", native: "üòÖ"
            },
            {
              code: "1F606", name: "smiling face with open mouth and tightly-closed eyes", native: "üòÜ"
            },
            {
              code: "1F601", name: "grinning face with smiling eyes", native: "üòÅ"
            },
            {
              code: "1F602", name: "face with tears of joy", native: "üòÇ"
            },
            {
              code: "1F60A", name: "smiling face with smiling eyes", native: "üòä"
            },
            {
              code: "263A", name: "white smiling face", native: "‚ò∫Ô∏è"
            },
            {
              code: "1F604", name: "smiling face with open mouth and smiling eyes", native: "üòÑ"
            },
            {
              code: "1F622", name: "crying face", native: "üò¢"
            },
            {
              code: "1F62D", name: "loudly crying face", native: "üò≠"
            },
            {
              code: "1F628", name: "fearful face", native: "üò®"
            },
            {
              code: "1F623", name: "persevering face", native: "üò£"
            },
            {
              code: "1F621", name: "pouting face", native: "üò°"
            },
            {
              code: "1F60C", name: "relieved face", native: "üòå"
            },
            {
              code: "1F616", name: "confounded face", native: "üòñ"
            },
            {
              code: "1F630", name: "face with open mouth and cold sweat", native: "üò∞"
            },
            {
              code: "1F614", name: "pensive face", native: "üòî"
            },
            {
              code: "1F612", name: "unamused face", native: "üòí"
            },
            {
              code: "1F624", name: "face with look of triumph", native: "üò§"
            },
            {
              code: "1F631", name: "face screaming in fear", native: "üò±"
            },
            {
              code: "1F62A", name: "sleepy face", native: "üò™"
            },
            {
              code: "1F60F", name: "smirking face", native: "üòè"
            },
            {
              code: "1F620", name: "angry face", native: "üò†"
            },
            {
              code: "1F629", name: "weary face", native: "üò©"
            },
            {
              code: "1F632", name: "astonished face", native: "üò≤"
            },
            {
              code: "1F61E", name: "disappointed face", native: "üòû"
            },
            {
              code: "1F635", name: "dizzy face", native: "üòµ"
            },
            {
              code: "1F613", name: "face with cold sweat", native: "üòì"
            }
          ],
          roomId: '',
          showEmoji: false,
          userId: '',
          userName: '',
          textarea: '',
          count: 0,
          messages: []
        }
      },
      created() {
        this.roomId = document.getElementById('roomId').value;
        // (this.createMap(jEmoji.EMOJI_MAP).slice(180, 218)).forEach(e => this.emojis.push(jEmoji.unifiedToHTML(e)));
        // ÂàùÂßãÂåñ
        this.init(this.roomId)
      },
      methods: {
        showPannel() {
          this.showEmoji = !this.showEmoji
        },
        selectE(e) {
          this.textarea += e.native;
          this.showEmoji = !this.showEmoji
        },
        getCookie(name) {
          if (!name || Object.prototype.toString.apply(name) !== '[object String]') return new Error('parm must be a string');
          let cookieArr = {}
          document.cookie && document.cookie.split(';').forEach(e => { e = e.replace(' ', ''); cookieArr[e.split('=')[0]] = e.split('=')[1] })
          return cookieArr[name]
        },
        init(id) {
          let self = this;
          this.userId = this.genUid()
          this.userName = this.getCookie('username')
          socket.emit("login", { id: this.userId, name: this.userName });
          socket.on("welcome", function (data) {
            self.messages.push({
              type: 3,
              info: data.name + ' Âä†ÂÖ•Êú¨Áæ§'
            })
            self.scrollToBottom();
          });

          socket.on("serverMsg", function (data) {
            self.insertMsg(data);
          });
          socket.on("logout", function (data) {
            self.messages.push({
              type: 3,
              info: data.name + ' Â∑≤ÈÄÄÂá∫'
            })
            self.scrollToBottom();
          });
          socket.on('updateCount', (data) => {
            self.count = parseInt(data, 10)
          })
        },
        insertMsg(obj) {
          let isMe = (obj.id === this.userId);
          if (isMe) {
            this.messages.push({
              type: 1,
              src: obj.src,
              time: obj.time,
              name: obj.name,
              info: obj.info,
              cms_url: obj.cms_url || '',
            })
          } else {
            // Â¢ûÂä†ËÆ∞ÂΩï
            this.messages.push({
              type: 2,
              src: obj.src,
              time: obj.time,
              name: obj.name,
              cmsUrl: obj.cms_url || '',
              info: obj.info + (obj.cms_url ? `<a href='${obj.cms_url}' class='link'>Êü•ÁúãÊõ¥Â§ö</a>` : '')
            })
            // Êé®ÂπøÂõæ
            if (obj.img) {
              this.messages.push({
                type: 2,
                src: obj.src,
                time: obj.time,
                name: obj.name,
                img: obj.img
              })
            }
          }
          this.scrollToBottom()
        },
        sendText(e) {
          if (!this.textarea) return
          e.stopPropagation()
          e.preventDefault();
          this.sendMsg()
        },
        sendMsg() {
          if (!this.textarea) return
          var msg = {
            id: this.userId,
            info: this.textarea,
            time: moment().format('M/D HH:mm:ss')
          };
          socket.emit('newMsg', msg);
          this.textarea = ''
        },
        scrollToBottom() {
          var sum = 0;
          $(".chatBox-ul li").each((i, e) => {
            sum += $(e).outerHeight();
          });
          $(".chatBox-ul").animate({ scrollTop: sum }, 100, 'easeInQuint');
        },
        genUid() {
          return new Date().getTime() + "" + Math.floor(Math.random() * 899 + 100);
        }
      },
      directives: {
        focus: {
          // ÂΩìÁªëÂÆöÂÖÉÁ¥†ÊèíÂÖ•Âà∞ DOM ‰∏≠„ÄÇ
          inserted: function (el) {
            // ËÅöÁÑ¶ÂÖÉÁ¥†
            el.focus()
          }
        }
      }
    })
  </script>
</body>

</html>